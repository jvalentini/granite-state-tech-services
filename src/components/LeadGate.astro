---
import { BUTTONDOWN_EMBED_URL, BUTTONDOWN_TAG_BLOG } from '../consts';

interface Props {
  slug: string;
  preview: string;
  ctaTitle?: string;
  ctaCopy?: string;
  formAction?: string;
  formMethod?: 'POST' | 'GET';
  tag?: string;
}

const {
  slug,
  preview,
  ctaTitle = 'Unlock the full article',
  ctaCopy = 'Drop your email to read the rest and get new workshop and SEO insights.',
  formAction = BUTTONDOWN_EMBED_URL,
  formMethod = 'POST',
  tag = BUTTONDOWN_TAG_BLOG
} = Astro.props;

const unlockKey = `gsts_gate_${slug}`;
const iframeName = `buttondown-embed-${slug}`;
---
<section class="lead-gate" data-unlock-key={unlockKey} data-slug={slug}>
  <div class="lead-preview">
    <p class="preview-text">{preview}</p>
  </div>

  <div class="lead-form surface">
    <div>
      <p class="eyebrow">Member preview</p>
      <h3>{ctaTitle}</h3>
      <p>{ctaCopy}</p>
    </div>
    <form class="lead-form-fields" action={formAction} method={formMethod} target={iframeName} data-action={formAction}>
      <input type="email" name="email" placeholder="you@company.com" required />
      <input type="hidden" name="embed" value="1" />
      {tag && <input type="hidden" name="tag" value={tag} />}
      <button class="btn btn-primary" type="submit">Unlock article</button>
      <p class="lead-status" aria-live="polite"></p>
    </form>
    <button class="btn btn-ghost confirm-button" type="button" hidden>I confirmed by email, unlock now</button>
    <p class="lead-note">No spam. Unsubscribe anytime.</p>
  </div>

  <iframe title="buttondown" name={iframeName} style="display:none;"></iframe>

  <div class="lead-full" hidden>
    <slot />
  </div>
</section>

<script is:inline>
  const gate = document.currentScript?.previousElementSibling;
  if (gate) {
    const unlockKey = gate.getAttribute('data-unlock-key');
    const slug = gate.getAttribute('data-slug') || '';
    const full = gate.querySelector('.lead-full');
    const form = gate.querySelector('form');
    const status = gate.querySelector('.lead-status');
    const confirmButton = gate.querySelector('.confirm-button');

    const track = (eventName, extra = {}) => {
      window.dispatchEvent(new CustomEvent('gsts:event', { detail: { event: eventName, ...extra } }));
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({ event: eventName, ...extra });
    };

    const unlock = (source, message) => {
      if (unlockKey) localStorage.setItem(unlockKey, 'true');
      if (full) full.hidden = false;
      gate.querySelector('.lead-form')?.setAttribute('hidden', '');
      if (message && status) status.textContent = message;
      track('lead_gate_unlocked', { slug, source });
    };

    const hasUnlockFlag = unlockKey && localStorage.getItem(unlockKey) === 'true';
    const previewUnlock = new URLSearchParams(window.location.search).get('unlock') === '1';

    if (hasUnlockFlag || previewUnlock) {
      unlock(previewUnlock ? 'preview_param' : 'local_storage', previewUnlock ? 'Preview mode: content unlocked.' : '');
    }

    form?.addEventListener('submit', (event) => {
      const emailField = form.querySelector('input[type="email"]');
      const email = emailField?.value?.trim();
      if (!email) {
        event.preventDefault();
        if (status) status.textContent = 'Please enter a valid email.';
        return;
      }

      if (status) {
        status.textContent =
          'Check your inbox and click confirm. Then return and use the unlock button below.';
      }
      confirmButton?.removeAttribute('hidden');
      track('lead_gate_submit', { slug, tag: form.querySelector('input[name="tag"]')?.value || '' });
    });

    confirmButton?.addEventListener('click', () => {
      unlock('manual_confirmation', 'Thanks. Full article unlocked for this browser.');
    });
  }
</script>

<style>
  .lead-gate {
    display: grid;
    gap: var(--space-xl);
  }

  .lead-preview {
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    background: rgba(17, 24, 20, 0.5);
  }

  .preview-text {
    color: var(--text-muted);
    font-size: 1.05rem;
  }

  .lead-form {
    padding: var(--space-xl);
    display: grid;
    gap: var(--space-lg);
  }

  .lead-form-fields {
    display: grid;
    gap: var(--space-sm);
  }

  .lead-form-fields input {
    padding: 0.8rem 1rem;
    border-radius: var(--radius-pill);
    border: 1px solid rgba(232, 227, 218, 0.2);
    background: rgba(8, 12, 10, 0.7);
    color: var(--text);
    font-size: 1rem;
  }

  .lead-status {
    min-height: 1.2rem;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  .lead-note {
    color: var(--text-dim);
    font-size: 0.85rem;
  }

  .confirm-button {
    justify-self: start;
  }
</style>
